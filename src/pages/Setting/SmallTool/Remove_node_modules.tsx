import { Button, Checkbox, Form, Input, InputNumber, Message } from '@arco-design/web-react'
import { IconDelete } from '@arco-design/web-react/icon'
import { invoke } from '@tauri-apps/api/core'
import { Fragment, useEffect, useRef, useState } from 'react'
import { SettingData } from '../../../type'

export default function Remove_node_modules() {
  const [form] = Form.useForm()

  const [loading, setLoading] = useState(false)

  useEffect(() => {
    invoke('getSetting').then((data: SettingData) => {
      form.setFieldsValue({
        nodeModulesFolders: data.nodeModulesFolders || []
      })
    })
  }, [])

  const remove = async () => {
    const values = (await invoke('getSetting')) as any
    await invoke('saveSetting', { settingData: { ...values, nodeModulesFolders: form.getFieldValue('nodeModulesFolders') } })

    await form.validate()

    setLoading(true)

    invoke('removeFolder', { nodeModulesFolders: form.getFieldValue('nodeModulesFolders') })
      .then(res => {
        console.log('res', res)
        Message.success({ content: '成功', position: 'bottom' })
      })
      .catch(err => {
        Message.error({ content: err, position: 'bottom' })
      })
      .finally(() => {
        setLoading(false)
      })
  }

  return (
    <Form form={form}>
      <Form.Item label=" ">
        <Button loading={loading} onClick={remove} status="danger">
          执行删除
        </Button>
      </Form.Item>

      <Form.Item label="文件夹路径列表" rules={[{ required: true }]}>
        <Form.List field="nodeModulesFolders">
          {(fields, { add, remove }) => {
            return (
              <>
                {fields.map((item, index) => {
                  return (
                    <Fragment key={item.key}>
                      <div className="flex gap-[10px]">
                        <div className="flex-grow flex gap-4 ">
                          <Form.Item field={item.field + '.selected'} className="w-auto">
                            <Checkbox />
                          </Form.Item>
                          <Form.Item field={item.field + '.path'} rules={[{ required: true }]}>
                            <Input placeholder="" />
                          </Form.Item>
                        </div>

                        <div className="flex gap-2">
                          <Button
                            icon={<IconDelete />}
                            shape="circle"
                            status="danger"
                            className="shrink-0"
                            onClick={() => remove(index)}
                          />
                        </div>
                      </div>
                    </Fragment>
                  )
                })}

                <div className="flex gap-1">
                  <Button onClick={() => add()}>add</Button>
                </div>
              </>
            )
          }}
        </Form.List>
      </Form.Item>
    </Form>
  )
}
